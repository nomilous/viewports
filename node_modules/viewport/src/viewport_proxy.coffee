module.exports = class ViewportProxy

    constructor: -> 

        @viewports = {}
        @index     = id2group: {} 

    protocol: (When, Then, edge) => 

        When 'disconnect', => 

            @handleDisconnect edge

        When 'viewport:connect', (data) => 

            Then 'viewport:connect:ok', @handleConnect edge, data

        When 'viewport:event', (data) => 

            @handleEvent edge, data

    handleConnect: (edge, data) -> 

        id    = edge.localId()
        group = data.group

        @index.id2group[id] = group
        @viewports[group] ||= edges: {}
        @viewports[group].edges[id] = emit: edge.getPublisher()

        console.log 'CONNECTED', data
        console.log 'viewports', @viewports
        console.log 'index', @index

        return connectresponse: 'TODO'

    handleDisconnect: (edge) -> 

        id    = edge.localId()
        group = @index.id2group[id]

        delete @viewports[group].edges[id]
        delete @index.id2group[id]

        console.log 'DISCONNECTED', group
        console.log 'viewports', @viewports
        console.log 'index', @index

    handleEvent: (edge, data) ->

        id    = edge.localId()
        group = @index.id2group[id]

        return unless group

        for peerId of @viewports[group].edges

            #
            # dont proxy back to source
            #

            #continue if peerId == id

            #
            # TODO: may have problems here if sockets 
            #       vanish without a the disconnect event
            # 

            @viewports[group].edges[peerId].emit 'viewport:event', data

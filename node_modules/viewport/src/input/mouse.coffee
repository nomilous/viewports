if typeof define isnt 'function' then define = require('amdefine')(module)

define -> 

    #
    # fallback if no event.movement[X|Y]
    #

    prevX = prevY = null

    dx = (x) -> 
        unless prevX
            prevX = x
            return 0
        delta = x - prevX
        prevX = x
        return delta

    dy = (y) -> 
        unless prevY
            prevY = y
            return 0
        delta = y - prevY
        prevY = y
        return delta


    service = 

        init: (config) -> 

            service.uplink = config.uplink
            document.addEventListener 'mousemove', service.onEvent, false

        include: (e) -> 

            x = e.movementX || e.mozMovementX || e.webkitMovementX
            x = dx e.clientX if typeof x == 'undefined'

            y = e.movementY || e.mozMovementY || e.webkitMovementY
            y = dy e.clientY if typeof y == 'undefined'

            type: e.type
            keyCode: e.keyCode || 0
            movementX: x
            movementY: y

        onEvent: (e) -> 

            service.uplink.emit 'viewport:event', service.include e

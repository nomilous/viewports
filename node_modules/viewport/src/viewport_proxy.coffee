module.exports = class ViewportProxy

    constructor: (@sockets) -> 

        @viewports = {}
        @index     = id2group: {} 

        @sockets.on 'connection', (socket) =>

            socket.on 'disconnect', (data) => @handleDisconnect socket
            socket.on 'viewport:connect', (data) => @handleConnect socket, data
            socket.on 'viewport:event', (data) => @handleEvent socket, data

    handleConnect: (socket, data) -> 

        group = data.group
        @viewports[group] ||= sockets: {}
        @viewports[group].sockets[socket.id] = socket
        @index.id2group[socket.id] = group

        console.log 'CONNECTED', data
        console.log 'viewports', @viewports
        console.log 'index', @index

        socket.emit 'viewport:connect:ok', {}

    handleDisconnect: (socket) -> 

        group = @index.id2group[socket.id]
        delete @viewports[group].sockets[socket.id]
        delete @index.id2group[socket.id]

        console.log 'DISCONNECTED', group
        console.log 'viewports', @viewports
        console.log 'index', @index

    handleEvent: (socket, data) -> 

        group = @index.id2group[socket.id]

        return unless group

        for id of @viewports[group].sockets

            #
            # dont proxy back to source
            #

            continue if id == socket.id

            #
            # TODO: may have problems here if sockets 
            #       vanish without a the disconnect event
            # 

            @viewports[group].sockets[id].emit 'viewport:event', data

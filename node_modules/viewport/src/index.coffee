fs            = require 'fs'
ViewportProxy = require './viewport_proxy' 
cache         = {}

cached = (name, callback) -> 

    #
    # TODO: error handling, clientside cache config
    #

    if cache[name]

        callback null, cache[name]
        return

    switch name

        when 'three'

            fs.readFile __dirname + '/../node_modules/three/three.js', (err, data) -> 
                cache[name] = data
                callback null, data

        when 'require'

            fs.readFile __dirname + '/../node_modules/requirejs/require.js', (err, data) -> 
                cache[name] = data
                callback null, data

        else

            fs.readFile __dirname + "/#{ name }.js", (err, data) -> 
                #
                # TODO: cache[name] = data
                #
                callback null, data




module.exports = 

    scripts: (req, res, next) -> 

        #
        # middleware - responds to '/viewport/*.js'
        #
    
        if match = req.url.match /^\/viewport\/(.*).js$/

            cached match[1], (err, data) -> 
                res.set 'Content-Type', 'text/javascript'
                res.send data

            return

        next()

    listen: (sockets) -> 

        new ViewportProxy sockets
